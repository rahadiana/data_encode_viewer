<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Data URL / Base64 Viewer</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass:rgba(255,255,255,0.03)}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#e6eef6;background:linear-gradient(180deg,#071025 0%, #081229 60%);-webkit-font-smoothing:antialiased}
    .wrap{max-width:980px;margin:28px auto;padding:20px;background:var(--card);border-radius:12px;box-shadow:0 6px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    h1{margin:0 0 10px;font-size:20px}
    p.lead{margin:0 0 18px;color:var(--muted);font-size:13px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    .drop{flex:1;min-height:120px;padding:14px;border-radius:8px;border:2px dashed rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;text-align:center;background:var(--glass);cursor:pointer}
    .drop.dragover{border-color:var(--accent);box-shadow:0 6px 18px rgba(6,182,212,0.06)}
    .small{font-size:13px;color:var(--muted)}
    input[type=file]{display:none}
    .row{display:flex;gap:12px}
    .col{flex:1;min-width:0}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:#e6eef6;cursor:pointer;transition:all 0.2s}
    button:hover:not(:disabled){background:rgba(255,255,255,0.05);transform:translateY(-1px)}
    button:disabled{opacity:0.5;cursor:not-allowed}
    button.primary{background:linear-gradient(90deg,var(--accent),#60a5fa);border:none;color:#042027;font-weight:500}
    button.primary:hover:not(:disabled){box-shadow:0 4px 12px rgba(6,182,212,0.3)}
    .field{margin-top:12px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type=text], textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef6;font-size:13px;box-sizing:border-box}
    textarea{height:120px;resize:vertical;font-family:monospace}
    .preview{margin-top:12px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border:1px solid rgba(255,255,255,0.02)}
    .preview img{max-width:100%;height:auto;border-radius:6px;display:block}
    embed, iframe{width:100%;height:600px;border:0;border-radius:6px}
    pre{white-space:pre-wrap;word-break:break-word;font-family:monospace;font-size:13px;color:#dbeafe}
    .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:8px}
    .hint{font-size:12px;color:var(--muted)}
    .footer{margin-top:16px;font-size:12px;color:var(--muted)}
    .small-btn{padding:6px 8px;font-size:13px}
    .danger{color:#f87171}
  </style>
</head>
<body>
  <div class="wrap">
    <a href="https://rahadiana.github.io/data_encode_viewer/" target="_self" rel="noopener noreferrer"><h1>Data URL / Base64 Viewer</h1></a>
    <p class="lead">Upload gambar atau file, konversi ke Data URL (base64), dan dapatkan URL yang bisa dibagikan langsung. Murni HTML + JS + CSS.</p>

    <div class="controls">
      <label class="drop" id="dropzone">
        <div>
          <strong id="drop-title">Klik atau tarik file ke sini</strong>
          <div class="small" id="drop-sub">(images, pdf, text, docs — preview terbaik untuk image & pdf)</div>
        </div>
        <input id="fileInput" type="file" accept="*/*" />
      </label>
    </div>

    <div class="row">
      <div class="col">
        <div class="field">
          <label>Data URL (full)</label>
          <input type="text" id="dataUrlField" readonly />
        </div>

        <div class="field">
          <label>Base64 (payload saja)</label>
          <textarea id="base64Area" readonly placeholder="Base64 akan tampil di sini (payload saja)"></textarea>
        </div>

        <div class="meta">
          <div class="actions">
            <button id="openBtn" class="small-btn">Buka di tab baru</button>
            <button id="copyDataBtn" class="small-btn">Copy Data URL</button>
            <button id="copyBaseBtn" class="small-btn">Copy Base64</button>
            <button id="downloadBtn" class="small-btn">Download</button>
            <button id="makeShareBtn" class="small-btn primary">Buat Shareable URL</button>
            <button id="copyShareBtn" class="small-btn">Copy Share URL</button>
            <button id="shrinkBtn" class="small-btn primary">Shrink URL</button>
            <button id="copyShortBtn" class="small-btn">Copy Short URL</button>
            <button id="downloadShareBtn" class="small-btn">Download Share Page</button>
          </div>
          <div class="hint" id="fileInfo"></div>
        </div>
        <div class="field" id="publishArea" style="margin-top:10px;border-top:1px dashed rgba(255,255,255,0.03);padding-top:10px;">
          <label>Publish ke GitHub Pages (opsional)</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <input id="ghOwnerInput" type="text" placeholder="owner" style="width:110px" />
            <input id="ghRepoInput" type="text" placeholder="repo" style="width:140px" />
            <input id="ghBranchInput" type="text" placeholder="branch (default: main)" style="width:120px" />
            <input id="ghTokenInput" type="password" placeholder="Paste token (not stored)" style="width:220px" />
            <button id="publishBtn" class="small-btn">Publish to GitHub Pages</button>
          </div>
          <div class="hint" id="publishStatus" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="col">
        <div class="field">
          <label>Preview</label>
          <div class="preview" id="previewArea">
            <div class="hint" id="previewHint">Belum ada file.</div>
          </div>
        </div>
        <div class="field">
          <label>Catatan</label>
          <div class="hint">
            - Data URL bisa sangat besar untuk file besar.<br>
            - Shareable URL menyimpan Data URL di bagian fragment (hash), jadi tidak dikirim ke server.<br>
            - <strong>Shrink URL</strong> mencoba layanan TinyURL, is.gd, atau v.gd untuk membuat link pendek.<br>
            - Jika auto-shrink gagal (CORS/URL terlalu panjang), gunakan tinyurl.com atau bit.ly secara manual.<br>
            - Beberapa format (mis. .docx) tidak bisa ditampilkan langsung di browser — gunakan download.
          </div>
        </div>
      </div>
    </div>

    <div class="footer">Made simple — rahadiana</div>
  </div>

  <script>
    // Elemen
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const dataUrlField = document.getElementById('dataUrlField');
    const base64Area = document.getElementById('base64Area');
    const previewArea = document.getElementById('previewArea');
    const previewHint = document.getElementById('previewHint');
    const fileInfo = document.getElementById('fileInfo');
    const openBtn = document.getElementById('openBtn');
    const copyDataBtn = document.getElementById('copyDataBtn');
    const copyBaseBtn = document.getElementById('copyBaseBtn');
    const downloadBtn = document.getElementById('downloadBtn');
  const makeShareBtn = document.getElementById('makeShareBtn');
  const copyShareBtn = document.getElementById('copyShareBtn');
  const shrinkBtn = document.getElementById('shrinkBtn');
  const copyShortBtn = document.getElementById('copyShortBtn');
  const downloadShareBtn = document.getElementById('downloadShareBtn');
  const ghOwnerInput = document.getElementById('ghOwnerInput');
  const ghRepoInput = document.getElementById('ghRepoInput');
  const ghBranchInput = document.getElementById('ghBranchInput');
  const ghTokenInput = document.getElementById('ghTokenInput');
  const publishBtn = document.getElementById('publishBtn');
  const publishStatus = document.getElementById('publishStatus');

    let currentDataUrl = '';
    let currentFileName = 'file.bin';
    let currentMime = '';
    let currentShareUrl = '';
    let currentShortUrl = '';

    // Drag & Drop
    dropzone.addEventListener('click', ()=> fileInput.click());
    ;['dragenter','dragover'].forEach(e=> dropzone.addEventListener(e, (ev)=>{ ev.preventDefault(); ev.stopPropagation(); dropzone.classList.add('dragover'); }));
    ;['dragleave','drop'].forEach(e=> dropzone.addEventListener(e, (ev)=>{ ev.preventDefault(); ev.stopPropagation(); dropzone.classList.remove('dragover'); }));
    dropzone.addEventListener('drop', (ev)=>{
      const f = ev.dataTransfer.files && ev.dataTransfer.files[0];
      if (f) handleFile(f);
    });

    fileInput.addEventListener('change', (ev)=>{
      if (ev.target.files && ev.target.files[0]) handleFile(ev.target.files[0]);
    });

    // On load, if there's a hash with data URL, show it
    window.addEventListener('load', ()=>{
      if (location.hash && location.hash.length > 1) {
        try {
          const dataUrl = decodeURIComponent(location.hash.slice(1));
          if (dataUrl.startsWith('data:')) {
            showFromDataUrl(dataUrl, 'from-share');
          }
        } catch(e) {
          console.warn('Cant decode hash', e);
        }
      }
    });

    function handleFile(file){
      currentFileName = file.name || 'file.bin';
      currentMime = file.type || 'application/octet-stream';
      fileInfo.textContent = `${currentFileName} • ${currentMime} • ${humanSize(file.size)}`;
      const reader = new FileReader();
      reader.onload = (e)=>{
        const dataUrl = e.target.result; // already data:[mime];base64,...
        showFromDataUrl(dataUrl, file);
      };
      // use readAsDataURL to get base64 data URL
      reader.readAsDataURL(file);
    }

    function showFromDataUrl(dataUrl, file){
      currentDataUrl = dataUrl;
      // split payload
      const comma = dataUrl.indexOf(',');
      const meta = dataUrl.substring(5, comma); // after "data:"
      const payload = dataUrl.substring(comma + 1);
      
      // Extract mime from data URL
      let mime = '';
      if (meta.indexOf(';') !== -1) mime = meta.split(';')[0]; else mime = meta;
      
      // If file is provided (from upload), use its info
      if (file && typeof file === 'object' && file.name) {
        currentFileName = file.name || 'file.bin';
        currentMime = file.type || mime || 'application/octet-stream';
        fileInfo.textContent = `${currentFileName} • ${currentMime} • ${humanSize(file.size)}`;
      } else {
        // From share URL - extract info from data URL
        currentMime = mime || 'application/octet-stream';
        // Try to guess filename from mime
        let ext = 'bin';
        if (mime.startsWith('image/')) ext = mime.split('/')[1] || 'png';
        else if (mime === 'application/pdf') ext = 'pdf';
        else if (mime.startsWith('text/')) ext = 'txt';
        else if (mime === 'application/json') ext = 'json';
        currentFileName = 'shared-file.' + ext;
        fileInfo.textContent = `${currentFileName} • ${currentMime} • ${humanSize(payload.length * 0.75)} (perkiraan)`;
      }
      
      // update fields
  dataUrlField.value = dataUrl;
  base64Area.value = payload;
  currentShareUrl = ''; // invalidate until made
  currentShortUrl = ''; // invalidate short URL too
  copyShareBtn.disabled = true;
  copyShortBtn.disabled = true;
  if (downloadShareBtn) downloadShareBtn.disabled = true;

      // Clean up previous blob URL if exists
      if (window.currentPdfBlobUrl) {
        URL.revokeObjectURL(window.currentPdfBlobUrl);
        window.currentPdfBlobUrl = null;
      }

      // Set preview
      previewArea.innerHTML = '';
      previewHint.textContent = '';
      if (!mime) mime = currentMime || '';

      // Image
      if (mime.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = dataUrl;
        img.alt = currentFileName;
        previewArea.appendChild(img);
      } else if (mime === 'application/pdf' || currentFileName.toLowerCase().endsWith('.pdf')) {
        // Convert base64 to blob for better PDF support
        try {
          console.log('Creating PDF preview for:', currentFileName, 'MIME:', mime);
          const blob = dataURLtoBlob(dataUrl);
          console.log('Blob created:', blob.size, 'bytes');
          const blobUrl = URL.createObjectURL(blob);
          console.log('Blob URL created:', blobUrl);
          
          const object = document.createElement('object');
          object.data = blobUrl;
          object.type = 'application/pdf';
          object.style.width = '100%';
          object.style.height = '600px';
          object.style.borderRadius = '6px';
          
          // Fallback content
          object.innerHTML = `
            <div class="hint" style="padding:20px;text-align:center;">
              <p><strong>PDF Preview tidak tersedia di browser ini.</strong></p>
              <p>Gunakan tombol <strong>"Buka di tab baru"</strong> atau <strong>"Download"</strong> untuk melihat PDF.</p>
              <button onclick="window.open('${blobUrl}', '_blank')" style="margin-top:10px;padding:8px 16px;background:#06b6d4;border:none;border-radius:6px;color:#042027;cursor:pointer;font-weight:bold;">Buka PDF di Tab Baru</button>
            </div>
          `;
          
          previewArea.appendChild(object);
          
          // Store blob URL to prevent premature cleanup
          window.currentPdfBlobUrl = blobUrl;
          console.log('PDF preview loaded successfully');
        } catch(e) {
          console.error('PDF loading error:', e);
          previewArea.innerHTML = '<div class="hint" style="padding:20px;color:#f87171;"><strong>Error loading PDF:</strong> ' + e.message + '<br><br>Gunakan tombol <strong>"Download"</strong> atau <strong>"Buka di tab baru"</strong> untuk melihat PDF.</div>';
        }
      } else if (mime.startsWith('text/') || mime === 'application/json' || mime.endsWith('+xml')) {
        // show text content
        // decode base64 to text
        try {
          const decoded = atob(payload);
          // try to UTF-8 decode
          const text = utf8Decode(decoded);
          const pre = document.createElement('pre');
          pre.textContent = text;
          previewArea.appendChild(pre);
        } catch(e) {
          const pre = document.createElement('pre');
          pre.textContent = '[Gagal decode text preview]';
          previewArea.appendChild(pre);
        }
      } else {
        const div = document.createElement('div');
        div.className = 'hint';
        div.innerHTML = `Preview tidak tersedia untuk MIME <strong>${mime || 'unknown'}</strong>. Gunakan tombol Download.`;
        previewArea.appendChild(div);
      }

  // enable buttons
      openBtn.disabled = false;
      copyDataBtn.disabled = false;
      copyBaseBtn.disabled = false;
      downloadBtn.disabled = false;
      makeShareBtn.disabled = false;
  shrinkBtn.disabled = false;
  if (downloadShareBtn) downloadShareBtn.disabled = false;
    }

    openBtn.addEventListener('click', ()=>{
      if (!currentDataUrl) return alert('Belum ada data URL');
      // For PDF, use blob URL if available for better compatibility
      if ((currentMime === 'application/pdf' || currentFileName.toLowerCase().endsWith('.pdf')) && window.currentPdfBlobUrl) {
        window.open(window.currentPdfBlobUrl, '_blank');
      } else {
        window.open(currentDataUrl, '_blank');
      }
    });

    copyDataBtn.addEventListener('click', async ()=>{
      if (!currentDataUrl) return;
      try {
        await navigator.clipboard.writeText(currentDataUrl);
        copyDataBtn.textContent = 'Copied ✓';
        setTimeout(()=> copyDataBtn.textContent = 'Copy Data URL', 1500);
      } catch(e) {
        alert('Gagal copy: ' + e);
      }
    });

    copyBaseBtn.addEventListener('click', async ()=>{
      if (!base64Area.value) return;
      try {
        await navigator.clipboard.writeText(base64Area.value);
        copyBaseBtn.textContent = 'Copied ✓';
        setTimeout(()=> copyBaseBtn.textContent = 'Copy Base64', 1500);
      } catch(e) {
        alert('Gagal copy: ' + e);
      }
    });

    downloadBtn.addEventListener('click', ()=>{
      if (!currentDataUrl) return;
      const a = document.createElement('a');
      a.href = currentDataUrl;
      a.download = currentFileName || 'download.bin';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    makeShareBtn.addEventListener('click', ()=>{
      if (!currentDataUrl) return;
      // create a URL with the data url in the fragment (hash) — so it won't be sent to server
      try {
        currentShareUrl = location.origin + location.pathname + '#' + encodeURIComponent(currentDataUrl);
      } catch(e) {
        // fallback: base64 payload only
        currentShareUrl = location.origin + location.pathname + '#data:' + encodeURIComponent(currentDataUrl);
      }
      copyShareBtn.disabled = false;
      // update UI
      makeShareBtn.textContent = 'Share URL dibuat';
      setTimeout(()=> makeShareBtn.textContent = 'Buat Shareable URL', 1500);
    });

    copyShareBtn.addEventListener('click', async ()=>{
      if (!currentShareUrl) return alert('Belum membuat share URL, klik "Buat Shareable URL" dahulu');
      try {
        await navigator.clipboard.writeText(currentShareUrl);
        copyShareBtn.textContent = 'Copied ✓';
        setTimeout(()=> copyShareBtn.textContent = 'Copy Share URL', 1500);
      } catch(e) {
        alert('Gagal copy: ' + e);
      }
    });

    shrinkBtn.addEventListener('click', async ()=>{
      if (!currentShareUrl) return alert('Buat Shareable URL dahulu sebelum shrink');
      
      shrinkBtn.disabled = true;
      shrinkBtn.textContent = 'Shrinking...';
      
      try {
        // Try multiple URL shortener services
        let shortUrl = null;
        
        // Try 1: TinyURL API (more reliable with CORS)
        try {
          const tinyResponse = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(currentShareUrl)}`);
          if (tinyResponse.ok) {
            shortUrl = await tinyResponse.text();
            if (shortUrl && shortUrl.startsWith('http')) {
              console.log('TinyURL success:', shortUrl);
            } else {
              shortUrl = null;
            }
          }
        } catch(e) {
          console.log('TinyURL failed, trying next...', e);
        }
        
        // Try 2: is.gd API
        if (!shortUrl) {
          try {
            const isgdResponse = await fetch(`https://is.gd/create.php?format=json&url=${encodeURIComponent(currentShareUrl)}`);
            const isgdData = await isgdResponse.json();
            if (isgdData.shorturl) {
              shortUrl = isgdData.shorturl;
              console.log('is.gd success:', shortUrl);
            }
          } catch(e) {
            console.log('is.gd failed, trying next...', e);
          }
        }
        
        // Try 3: v.gd API (similar to is.gd)
        if (!shortUrl) {
          try {
            const vgdResponse = await fetch(`https://v.gd/create.php?format=json&url=${encodeURIComponent(currentShareUrl)}`);
            const vgdData = await vgdResponse.json();
            if (vgdData.shorturl) {
              shortUrl = vgdData.shorturl;
              console.log('v.gd success:', shortUrl);
            }
          } catch(e) {
            console.log('v.gd failed', e);
          }
        }
        
        if (shortUrl) {
          currentShortUrl = shortUrl;
          copyShortBtn.disabled = false;
          shrinkBtn.textContent = 'Shrink URL ✓';
          alert('Short URL berhasil dibuat!\n\n' + currentShortUrl);
          setTimeout(()=> shrinkBtn.textContent = 'Shrink URL', 2000);
        } else {
          throw new Error('Semua layanan shortener gagal. Mungkin karena CORS policy atau URL terlalu panjang.');
        }
      } catch(e) {
        console.error('Shrink URL error:', e);
        alert('Error membuat short URL: ' + e.message + '\n\nAlternatif:\n1. Copy Share URL dan buka tinyurl.com atau bit.ly\n2. Paste URL di sana untuk membuat short URL manual');
        shrinkBtn.textContent = 'Shrink URL';
      } finally {
        shrinkBtn.disabled = false;
      }
    });

    copyShortBtn.addEventListener('click', async ()=>{
      if (!currentShortUrl) return alert('Belum membuat short URL, klik "Shrink URL" dahulu');
      try {
        await navigator.clipboard.writeText(currentShortUrl);
        copyShortBtn.textContent = 'Copied ✓';
        setTimeout(()=> copyShortBtn.textContent = 'Copy Short URL', 1500);
      } catch(e) {
        alert('Gagal copy: ' + e);
      }
    });

    // Helper: generate share HTML
    function generateShareHtml(){
      const safeName = (currentFileName || 'shared').replace(/[^a-zA-Z0-9._-]/g, '_');
      const html = `<!doctype html>\n<html lang="en">\n<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Shared file</title></head>\n<body>Loading...<script>\n  try{\n    const dataUrl = ${JSON.stringify(currentDataUrl)};\n    // navigate to the data URL to display/download\n    window.location.replace(dataUrl);\n  }catch(e){\n    document.body.innerHTML = '<pre style="white-space:pre-wrap;word-break:break-word;font-family:monospace">Error opening file: '+e+"\\n\\nData URL:\\n"+${JSON.stringify(currentDataUrl)}+'</pre>';\n  }\n<\\/script></body>\n</html>`;
      return { html, safeName };
    }

    // Download a small HTML page that redirects to the data URL (useful for hosting as a static file)
    downloadShareBtn.addEventListener('click', ()=>{
      if (!currentDataUrl) return alert('Belum ada file untuk dibuat halaman share');
      try {
        const { html, safeName } = generateShareHtml();
        const blob = new Blob([html], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `share-${safeName}.html`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=> URL.revokeObjectURL(url), 60000);
      } catch(e) {
        alert('Gagal membuat halaman share: ' + e);
      }
    });

    // Publish to GitHub Pages: client-side via GitHub REST API (user-provided token)
    publishBtn.addEventListener('click', async ()=>{
      if (!currentDataUrl) return alert('Belum ada file untuk dibuat halaman share');
      const owner = (ghOwnerInput.value || '').trim();
      const repo = (ghRepoInput.value || '').trim();
      const token = (ghTokenInput.value || '').trim();
      const branch = (ghBranchInput.value || 'main').trim() || 'main';
      if (!owner || !repo || !token) return alert('Isi owner, repo, dan token GitHub (token tidak disimpan).');
      if (!confirm('Token hanya digunakan sekali untuk meng-commit file ke repo Anda. Token tidak disimpan. Lanjutkan?')) return;

      publishStatus.textContent = 'Mempublish...';
      publishBtn.disabled = true;
      try {
        const { html, safeName } = generateShareHtml();
        // encode utf8 -> base64
        const base64 = btoa(unescape(encodeURIComponent(html)));
        const path = `share-${safeName}.html`;
        const apiUrl = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}`;
        const body = {
          message: `Add share page ${path}`,
          content: base64,
          branch: branch
        };
        const res = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            'Authorization': 'token ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) {
          console.error('GitHub API error', data);
          throw new Error(data.message || JSON.stringify(data));
        }
        // Success
        const ghUrl = `https://${owner}.github.io/${repo}/${path}`;
        publishStatus.innerHTML = `Published: <a href="${ghUrl}" target="_blank" rel="noopener">${ghUrl}</a>`;
      } catch(e) {
        console.error('Publish error', e);
        publishStatus.textContent = 'Error: ' + (e.message || e);
      } finally {
        publishBtn.disabled = false;
      }
    });

    // Helpers
    function humanSize(bytes){
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
      if (bytes < 1024*1024*1024) return (bytes/(1024*1024)).toFixed(2) + ' MB';
      return (bytes/(1024*1024*1024)).toFixed(2) + ' GB';
    }

    // atob result is binary string; we try to decode as UTF-8
    function utf8Decode(binStr){
      try {
        // convert binary string to Uint8Array
        const len = binStr.length;
        const bytes = new Uint8Array(len);
        for (let i=0;i<len;i++) bytes[i] = binStr.charCodeAt(i);
        const dec = new TextDecoder(); // utf-8
        return dec.decode(bytes);
      } catch(e){
        // fallback
        return binStr;
      }
    }

    // Convert Data URL to Blob (for better PDF support)
    function dataURLtoBlob(dataUrl){
      try {
        const parts = dataUrl.split(',');
        if (parts.length < 2) throw new Error('Invalid data URL format');
        
        // Extract mime type
        let mime = 'application/octet-stream';
        const mimeMatch = parts[0].match(/:(.*?);/);
        if (mimeMatch && mimeMatch[1]) {
          mime = mimeMatch[1];
        }
        
        // Decode base64
        const bstr = atob(parts[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while(n--){
          u8arr[n] = bstr.charCodeAt(n);
        }
        return new Blob([u8arr], {type: mime});
      } catch(e) {
        console.error('Error converting data URL to blob:', e);
        throw e;
      }
    }

  </script>
</body>
</html>
